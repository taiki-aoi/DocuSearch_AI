# 課題管理

このドキュメントでは、DocuSearch_AIの既知の課題と対応状況を管理します。

---

## 未解決の課題

### Issue #1: フィルター機能・画像アクション分岐の問題

**ステータス**: 🔴 未解決

**現象**:
- 削除したファイルがDifyに連携されない
- 既に登録済みのファイルが再度処理される（重複登録）

**影響範囲**:
- n8n ワークフロー: `local-folder-monitor.json`
- 画像処理分岐ロジック

**期待する動作**:
- 新規ファイルのみ処理する
- 削除されたファイルはDifyからも削除される
- 既存ファイルはスキップする

**調査ポイント**:
- [ ] 処理済みファイルの判定ロジック
- [ ] ファイル削除検知の実装
- [ ] Dify側のドキュメント削除API連携

---

### Issue #2: フォルダ同期機能の改善

**ステータス**: 🔴 未解決

**対象フォルダ**:
```
C:\Users\begin\Desktop\wk\02.実験\DocuSearch_AI\watch\documents
C:\Users\begin\Desktop\wk\02.実験\DocuSearch_AI\watch\images
```

**要件**:

| 操作 | 期待する動作 | 現状 |
| ---- | ------------ | ---- |
| ファイル追加 | 差分のみDifyに登録 | △ 重複登録の可能性あり |
| ファイル変更 | 更新をDifyに反映 | × 未実装 |
| ファイル削除 | Difyからも削除 | × 未実装 |

**必要な実装**:
- [ ] 処理済みファイルリストの永続化（DB or ファイル）
- [ ] ファイルハッシュによる変更検知
- [ ] 削除検知とDify同期削除
- [ ] Dify Document ID とローカルファイルの紐付け管理

**技術的な検討事項**:
```
【同期方式の選択肢】

A) ファイルベース管理
   - processed_files.json にファイルパスとDify Document IDを保存
   - シンプルだが、大量ファイルでパフォーマンス懸念

B) データベース管理
   - PostgreSQLに同期テーブルを作成
   - スケーラブルだが、実装コスト増

C) n8n内蔵のデータストア
   - n8nのstatic dataを活用
   - 手軽だが、データ量制限あり
```

---

### Issue #3: n8nの商用利用における制限

**ステータス**: 🔴 未解決（アーキテクチャ課題）

**課題**:

n8nはMVP検証には最適だが、商用マルチテナント運用には不向き。

| 課題 | 詳細 |
| ---- | ---- |
| **APIキー管理** | 全ユーザーが同一n8nインスタンスを共有 → キーの分離が困難 |
| **マルチテナント** | n8nは基本的にシングルテナント設計 |
| **ユーザー認証** | n8nの認証は管理者向け、エンドユーザー向けではない |
| **課金・使用量管理** | ユーザーごとのAPI使用量トラッキングが困難 |
| **スケーラビリティ** | ワークフロー実行の水平スケールが難しい |

**現状 vs あるべき姿**:

```text
【現状: n8n】
全ユーザー → 同一n8n → 同一APIキー → 課金の分離不可

【あるべき姿: 自作バックエンド】
ユーザーA → 自作API → 管理者のAPIキー（使用量をユーザーに紐付け）
ユーザーB → 自作API → 同上
```

**推奨対応**: n8nを自作バックエンドに置き換え

---

### Issue #4: Difyの商用利用における制限

**ステータス**: 🔴 未解決（アーキテクチャ課題）

**課題**:

DifyもMVP検証向けであり、商用運用には以下の制限がある。

| 課題 | 詳細 |
| ---- | ---- |
| **フォルダブラウジング** | フォルダ階層での絞り込み不可 |
| **カスタムUI** | 企業ブランディング、独自デザインが困難 |
| **権限管理** | フォルダ・ドキュメント単位の細かい権限設定不可 |
| **メタデータフィルタ** | カスタムメタデータでの検索フィルタが限定的 |
| **ブラックボックス** | 内部動作が不明、デバッグが困難 |

**そもそもDifyは必要だったか？**

Google AI Studio / Vertex AI でも同等の機能は実現可能：

| 機能 | Google AI Studio | Dify |
| ---- | ---------------- | ---- |
| Embedding生成 | ✅ gemini-embedding-001 | ✅ |
| LLM呼び出し | ✅ Gemini API | ✅ |
| RAG構築 | ✅ Vertex AI Search | ✅ |
| ベクトルDB | ✅ Vertex AI Vector Search | Weaviate |
| 検索UI | ❌ 自作必要 | ✅ 標準搭載 |
| ナレッジ管理UI | ❌ | ✅ |

**DifyをMVPで使った価値**:

| 観点 | Google直接 | Dify |
| ---- | ---------- | ---- |
| 検索UI | 自作必要（数日） | すぐ使える |
| ナレッジ管理 | API実装必要 | GUI操作 |
| パラメータ調整 | コード変更が必要 | 画面で即変更（10秒） |
| 動作確認 | 実装後 | 即座に可能 |

**結論**: MVPフェーズでは正解。商用では不要。

```text
【MVP構成】
ファイル → n8n → Dify → Weaviate → Dify UI
                  ↑ ここが検証に便利だった（UIあり、即座に確認）

【商用構成】
ファイル → FastAPI → Gemini API → Weaviate → React UI
                  ↑ Dify不要、直接呼び出しでコスト削減・透明性向上
```

**推奨対応**: 商用ではDifyを完全に除外し、Gemini API直接呼び出し + 自作UI

---

### Issue #5: 環境変数・シークレット管理

**ステータス**: 🟡 一部対応済み

**対応済み**:
- [x] `.env` を `.gitignore` に追加
- [x] `.claude/settings.local.json` を `.gitignore` に追加
- [x] `image-processing.json` のAPIキーを環境変数参照に変更

**残課題**:
- [ ] APIキーのローテーション運用
- [ ] 本番環境でのシークレット管理（Vault等）
- [ ] n8n Credentialsの安全な管理

---

### Issue #6: 画像処理ワークフローの環境変数アクセス

**ステータス**: ✅ 解決済み

**現象**: `access to env vars denied` エラー

**原因**: n8nのセキュリティ設定で環境変数アクセスがブロックされていた

**解決策**: `docker-compose.yml` に以下を追加
```yaml
N8N_BLOCK_ENV_ACCESS_IN_NODE: 'false'
```

**対応日**: 2024-12-20

---

## 商用化に向けた課題サマリー

### 置き換えが必要なコンポーネント

| コンポーネント | MVP | 商用 | 理由 |
| -------------- | --- | ---- | ---- |
| **n8n** | ✅ | ❌ → 自作バックエンド | マルチテナント、課金管理 |
| **Dify** | ✅ | △ → API利用 or 自作 | カスタムUI、権限管理 |
| **Weaviate** | ✅ | ✅ 継続利用可 | スケーラブル |
| **PostgreSQL** | ✅ | ✅ 継続利用可 | 標準的なRDB |
| **Redis** | ✅ | ✅ 継続利用可 | キャッシュ・キュー |

### 自作が必要な部分

| コンポーネント | 役割 | 技術候補 |
| -------------- | ---- | -------- |
| **バックエンドAPI** | ファイル処理、API呼び出し | FastAPI (Python) |
| **ジョブキュー** | バックグラウンド処理 | Celery + Redis |
| **ユーザー管理** | 認証、使用量トラッキング | FastAPI + PostgreSQL |
| **フロントエンド** | カスタムUI | React / Next.js |
| **RAGエンジン** | 検索・回答生成 | LangChain / LlamaIndex |

---

## 解決済みの課題

### ~~Issue #0: 検索精度が低い~~

**ステータス**: ✅ 解決済み

**原因**: Embeddingモデル `embedding-001` の日本語対応が不十分

**解決策**: `gemini-embedding-001` に変更

**対応日**: 2024-12-20

---

## 優先度

| 優先度 | Issue | 理由 |
| ------ | ----- | ---- |
| 高 | #1 | 重複登録でナレッジベースが汚染される |
| 高 | #2 | 削除が反映されないと運用に支障 |

---

## 関連ドキュメント

- [アーキテクチャ](./ARCHITECTURE.md)
- [開発戦略](./DEVELOPMENT_STRATEGY.md)
- [n8nワークフロー設定](./N8N_WORKFLOW_SETUP.md)
