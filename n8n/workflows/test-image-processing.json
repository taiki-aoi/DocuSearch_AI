{
  "name": "TEST - Image Processing",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "id": "manual-trigger",
      "name": "æ‰‹å‹•å®Ÿè¡E,
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [0, 0]
    },
    {
      "parameters": {
        "filePath": "/watch/images/test.jpg",
        "options": {}
      },
      "id": "read-test-file",
      "name": "ãƒE‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿",
      "type": "n8n-nodes-base.readBinaryFile",
      "typeVersion": 1,
      "position": [220, 0]
    },
    {
      "parameters": {
        "jsCode": "// å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨ç”»åƒãEBase64ã‚’å–å¾—\nconst item = $input.first();\nconst binaryData = item.binary?.data;\n\nif (!binaryData) {\n  throw new Error('No binary data found');\n}\n\n// Base64ãƒEEã‚¿ã‚’æ­£ã—ãå–å¾—\nconst binaryBuffer = await this.helpers.getBinaryDataBuffer(0, 'data');\nconst base64String = binaryBuffer.toString('base64');\nconst fileName = binaryData.fileName || 'test.jpg';\nconst mimeType = binaryData.mimeType || 'image/jpeg';\n\n// EXIFãƒEEã‚¿Eˆç°¡æ˜“ç‰ˆE‰\nconst result = {\n  json: {\n    originalPath: '/watch/images/test.jpg',\n    fileName: fileName,\n    base64Data: base64String,\n    mimeType: mimeType,\n    fileSize: binaryData.fileSize,\n    exif: {\n      datetime: null,\n      latitude: null,\n      longitude: null,\n      has_gps: false,\n      camera_make: null,\n      camera_model: null\n    },\n    location: {\n      formatted: 'ä½ç½®æƒE ±ãªãE,\n      full: null,\n      raw: null\n    }\n  }\n};\n\nreturn [result];"
      },
      "id": "extract-exif",
      "name": "EXIFæŠ½å‡ºãƒ»ãƒEEã‚¿æº–å‚™",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            { "name": "key", "value": "={{ $env.GEMINI_API_KEY }}" }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [{\n    \"parts\": [\n      {\n        \"text\": \"ã“ãEç”»åƒã‚’è©³ç´°ã«åˆEã—ã€æ¤œç´¢ç”¨ã®ãƒ¡ã‚¿ãƒEEã‚¿ã‚’ä½œæEã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ãEç‚¹ã‚’å«ã‚ã¦è¨˜è¿°ã—ã¦ãã ã•ã„Eš\\n\\n1. å†™ã£ã¦ãE‚‹ç‰©ä½“ï¼ˆåEä½“çš„ã«E‰\\n   - å»ºç‰©ãŒã‚ã‚‹å ´åˆã€ãã®ç¨®é¡ï¼ˆãEãƒ³ã‚·ãƒ§ãƒ³ã€ãƒ“ãƒ«ã€æˆ¸å»ºã¦ã€ã‚ªãƒ•ã‚£ã‚¹ã€å•†æ¥­æ–½è¨­ãªã©E‰\\n   - è»Šä¸¡ãŒã‚ã‚‹å ´åˆã€ç¨®é¡ï¼ˆä¹—ç”¨è»Šã€ãƒˆãƒ©ãƒE‚¯ã€ãƒã‚¤ã‚¯ãªã©E‰\\n   - äººç‰©ãŒã„ã‚‹å ´åˆã€äººæ•°ã¨çŠ¶æ³E¼ˆãƒ“ã‚¸ãƒã‚¹ã€ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã€ã‚¤ãƒ™ãƒ³ãƒˆãªã©E‰\\n\\n2. ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»å ´é¢\\n   - é£Ÿäº‹ã€ä¼šè­°ã€å·¥äº‹ç¾å ´ã€æ—…è¡Œã€ã‚¤ãƒ™ãƒ³ãƒˆã€æ—¥å¸¸ãªã©\\n   - æ–™ç†ãŒã‚ã‚‹å ´åˆã€ã‚¸ãƒ£ãƒ³ãƒ«Eˆã‚¤ã‚¿ãƒªã‚¢ãƒ³ã€å’Œé£Ÿã€ä¸­è¯ã€ã‚«ãƒ•ã‚§ãªã©E‰\\n\\n3. é›°å›²æ°—ã‚„è‰²å‘³\\n   - æ˜ã‚‹ãE€æš—ãE€ãƒ¢ãƒ€ãƒ³ã€ãƒ¬ãƒˆãƒ­ã€ãEãƒEEã€è½ã¡ç€ãEŸé›°å›²æ°—ãªã©\\n\\n4. èª­ã¿å–ã‚Œã‚‹æ–‡å­—æƒ…å ±\\n   - çœ‹æ¿ã€æ›¸ç±ã€æ²ç¤ºæ¿ãªã©èª­ã‚ã‚‹æ–E­—ãŒã‚ã‚Œã°è¨˜è¿°\\n\\n5. å ´æ‰€ã®æ¨æ¸¬\\n   - å±‹åE/å±‹å¤–ã€EEå¸EéƒŠå¤Eè‡ªç„¶ãªã©\\n\\nå‡ºåŠ›ãEæ—¥æœ¬èªãEè‡ªç„¶ãªæ–E« ã§ã€æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åŒ–ã—ã‚„ã™ã„å½¢å¼ã§ãŠé¡˜ã„ã—ã¾ã™ã€E"\n      },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"{{ $json.mimeType }}\",\n          \"data\": \"{{ $json.base64Data }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.7,\n    \"maxOutputTokens\": 1024\n  }\n}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "gemini-vision",
      "name": "Gemini Vision API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [660, 0],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first();\nconst prevData = $('EXIFæŠ½å‡ºãƒ»ãƒEEã‚¿æº–å‚™').first().json;\nconst geminiResponse = item.json;\n\n// Geminiãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º\nlet caption = '';\ntry {\n  caption = geminiResponse.candidates[0].content.parts[0].text || '';\n} catch (e) {\n  caption = 'ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ç”ŸæEã‚¨ãƒ©ãƒ¼: ' + e.message;\n}\n\n// Difyç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰\nconst parts = [];\nparts.push(`â– ãƒ•ã‚¡ã‚¤ãƒ«åE ${prevData.fileName}`);\n\nif (prevData.exif && prevData.exif.datetime) {\n  parts.push(`â– æ’®å½±æ—¥æ™E ${prevData.exif.datetime}`);\n}\n\nif (prevData.location && prevData.location.formatted) {\n  parts.push(`â– æ’®å½±å ´æ‰€: ${prevData.location.formatted}`);\n}\n\nparts.push('â– ç”»åƒåEå®¹ã®èª¬æ˜E');\nparts.push(caption);\n\nconst documentText = parts.join('\\n');\n\nreturn [{\n  json: {\n    fileName: prevData.fileName,\n    originalPath: prevData.originalPath,\n    visionCaption: caption,\n    documentText: documentText\n  }\n}];"
      },
      "id": "build-document",
      "name": "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹ç¯E,
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://dify-api:5001/v1/datasets/c099198f-c9ea-48d6-b194-6beac4d336be/document/create-by-text",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"name\": \"{{ $json.fileName }}\",\n  \"text\": {{ JSON.stringify($json.documentText) }},\n  \"indexing_technique\": \"high_quality\",\n  \"process_rule\": {\n    \"mode\": \"automatic\"\n  }\n}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "dify-index",
      "name": "Difyç™»éŒ²",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1100, 0],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 3000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "dataset-api-key",
          "name": "Dataset API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first();\nconst prevData = $('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹ç¯E).first().json;\nconst difyResponse = item.json;\n\nreturn [{\n  json: {\n    success: true,\n    message: 'Image processed and indexed successfully',\n    fileName: prevData.fileName,\n    originalPath: prevData.originalPath,\n    documentId: difyResponse.document?.id || null,\n    visionCaption: prevData.visionCaption,\n    processedAt: new Date().toISOString()\n  }\n}];"
      },
      "id": "result",
      "name": "ãƒE‚¹ãƒˆçµæœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1320, 0]
    }
  ],
  "connections": {
    "æ‰‹å‹•å®Ÿè¡E: {
      "main": [
        [{ "node": "ãƒE‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿", "type": "main", "index": 0 }]
      ]
    },
    "ãƒE‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿": {
      "main": [
        [{ "node": "EXIFæŠ½å‡ºãƒ»ãƒEEã‚¿æº–å‚™", "type": "main", "index": 0 }]
      ]
    },
    "EXIFæŠ½å‡ºãƒ»ãƒEEã‚¿æº–å‚™": {
      "main": [
        [{ "node": "Gemini Vision API", "type": "main", "index": 0 }]
      ]
    },
    "Gemini Vision API": {
      "main": [
        [{ "node": "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹ç¯E, "type": "main", "index": 0 }]
      ]
    },
    "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹ç¯E: {
      "main": [
        [{ "node": "Difyç™»éŒ²", "type": "main", "index": 0 }]
      ]
    },
    "Difyç™»éŒ²": {
      "main": [
        [{ "node": "ãƒE‚¹ãƒˆçµæœ", "type": "main", "index": 0 }]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": ["docusearch", "test"]
}
